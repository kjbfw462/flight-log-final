<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>機体詳細</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <a href="/drones.html" class="back-link">&lt; 機体一覧に戻る</a>
        
        <div id="error-display" style="color: red; padding: 1em; display: none;"></div>

        <div id="main-content">
            <div class="header-actions">
                <h1 id="drone-name-title">機体詳細</h1>
                <a href="#" id="edit-button" class="blue-btn">この機体を編集する</a>
            </div>
            <div class="form-view-container">
                <div class="form-group">
                    <label>製造者</label>
                    <p id="manufacturer"></p>
                </div>
                <div class="form-group">
                    <label>型式</label>
                    <p id="model"></p>
                </div>
                <div class="form-group">
                    <label>種類</label>
                    <p id="type"></p>
                </div>
                <div class="form-group">
                    <label>製造番号</label>
                    <p id="serial_number"></p>
                </div>
                <div class="form-group">
                    <label>登録記号</label>
                    <p id="registration_symbol"></p>
                </div>
                <div class="form-group">
                    <label>機体の愛称</label>
                    <p id="nickname"></p>
                </div>
                <div class="form-group">
                    <label>登録有効期間</label>
                    <p id="valid-period"></p>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const droneId = params.get('id');
            const errorDisplay = document.getElementById('error-display');
            const mainContent = document.getElementById('main-content');

            if (!droneId) {
                mainContent.style.display = 'none';
                errorDisplay.textContent = 'エラー: 機体IDが指定されていません。';
                errorDisplay.style.display = 'block';
                return;
            }

            try {
                const res = await fetch(`/api/drones/${droneId}`);
                if (!res.ok) throw new Error('機体情報の読み込みに失敗しました。');
                
                const json = await res.json();
                const drone = json.data;

                document.getElementById('drone-name-title').textContent = drone.nickname || drone.model;
                document.getElementById('manufacturer').textContent = drone.manufacturer || '未設定';
                document.getElementById('model').textContent = drone.model || '未設定';
                document.getElementById('type').textContent = drone.type || '未設定';
                document.getElementById('serial_number').textContent = drone.serial_number || '未設定';
                document.getElementById('registration_symbol').textContent = drone.registration_symbol || '未設定';
                document.getElementById('nickname').textContent = drone.nickname || '未設定';
                
                const startDate = drone.valid_period_start ? new Date(drone.valid_period_start).toLocaleDateString() : '未設定';
                const endDate = drone.valid_period_end ? new Date(drone.valid_period_end).toLocaleDateString() : '未設定';
                document.getElementById('valid-period').textContent = `${startDate} 〜 ${endDate}`;

                document.getElementById('edit-button').href = `/drone-form.html?id=${drone.id}`;

            } catch (err) {
                // ★★★ 変更点(2): エラー発生時はメインコンテンツを隠し、エラー領域にメッセージを表示 ★★★
                mainContent.style.display = 'none';
                errorDisplay.textContent = `エラー: ${err.message}`;
                errorDisplay.style.display = 'block';
            }
        });
    </script>
</body>
</html>