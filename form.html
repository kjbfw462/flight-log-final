<script>
  const form = document.getElementById('flight-form');
  const pageTitle = document.getElementById('page-title');
  const deleteButton = document.getElementById('delete-button');
  const droneSelect = document.getElementById('drone-select');
  const params = new URLSearchParams(window.location.search);
  const logId = params.get('id');

  const purposeDisplay = document.getElementById('purpose-display');
  const purposeHidden  = document.getElementById('purpose-hidden');
  const formDisplay    = document.getElementById('flight_form-display');
  const formHidden     = document.getElementById('flight_form-hidden');

  const startInput = document.getElementById('start-time');
  const endInput   = document.getElementById('end-time');
  const actualDisplay = document.getElementById('actual-time-display');
  const actualMinutes = document.getElementById('actual-time-minutes');

  // タイムゾーン問題を回避して日付をYYYY-MM-DD形式に変換する関数
  function toDateInputString(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function diffMinutes(hhmm1, hhmm2) {
    if (!hhmm1 || !hhmm2) return 0;
    const [h1, m1] = hhmm1.split(':').map(Number);
    const [h2, m2] = hhmm2.split(':').map(Number);
    let a = h1*60 + m1, b = h2*60 + m2, d = b - a;
    if (d < 0) d += 24*60;
    return d;
  }
  function formatMinutes(min) {
    if (!min || min <= 0) return '';
    const h = Math.floor(min/60), m = min%60;
    return h ? `${h}時間${m}分` : `${m}分`;
  }
  function calculateFlightTime() {
    const min = diffMinutes(startInput.value, endInput.value);
    actualDisplay.value = formatMinutes(min);
    actualMinutes.value = min;
  }

  async function fetchJSON(url, opts) {
    const res = await fetch(url, opts);
    if (!res.ok) {
      let msg = 'エラーが発生しました。';
      try { const j = await res.json(); if (j.error) msg = j.error; } catch {}
      throw new Error(msg);
    }
    return res.json();
  }

  async function populateDrones() {
    const json = await fetchJSON('/api/drones');
    droneSelect.innerHTML = '';
    if (!json.data || json.data.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = '（機体が登録されていません）';
      droneSelect.appendChild(opt);
      return;
    }
    json.data.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.textContent = d.nickname || d.model || `#${d.id}`;
      droneSelect.appendChild(opt);
    });
  }

  // --- モーダル管理 ---
  let activeModal = null, lastFocusedElement = null;
  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    lastFocusedElement = document.activeElement;
    activeModal = modal;
    modal.classList.add('is-open');
    document.body.classList.add('modal-open');
    const buttons = modal.querySelectorAll('button');
    if (buttons.length) buttons[0].focus();
    modal.addEventListener('keydown', trapTab);
  }
  function trapTab(e) {
    if (!activeModal || e.key !== 'Tab') return;
    const buttons = activeModal.querySelectorAll('button');
    if (!buttons.length) return;
    const first = buttons[0], last = buttons[buttons.length - 1];
    if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
    else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
  }
  function closeModal() {
    if (!activeModal) return;
    activeModal.classList.remove('is-open');
    document.body.classList.remove('modal-open');
    activeModal.removeEventListener('keydown', trapTab);
    activeModal = null;
    if (lastFocusedElement) lastFocusedElement.focus();
  }
  
  function populateForm(data) {
    Object.keys(data).forEach(key => {
        const el = form.elements[key];
        if (el && data[key] !== null) {
           if (el.type === 'radio') {
             const radio = form.querySelector(`input[name="${key}"][value="${data[key]}"]`);
             if (radio) radio.checked = true;
           } else if (el.type === 'date') {
             // ★★★ 日付がズレる問題をここで修正 ★★★
             el.value = toDateInputString(data[key]);
           } else {
             el.value = data[key];
           }
        }
    });
    if (data.purpose) { purposeHidden.value = data.purpose; purposeDisplay.value = data.purpose; }
    if (data.flight_form) { formHidden.value = data.flight_form; formDisplay.value = data.flight_form; }
    calculateFlightTime();
  }

  // --- 初期化とイベントリスナー ---
  window.addEventListener('load', async () => {
    try {
      await populateDrones();
      if (logId) {
        pageTitle.textContent = '飛行日誌の編集';
        deleteButton.style.display = 'block';
        const j = await fetchJSON(`/api/flight_logs/${encodeURIComponent(logId)}`);
        populateForm(j.data);
      }
    } catch (e) {
      alert(e.message);
    }
  });

  startInput.addEventListener('input', calculateFlightTime);
  endInput.addEventListener('input', calculateFlightTime);
  purposeDisplay.addEventListener('click', () => openModal('purpose-modal'));
  formDisplay.addEventListener('click', () => openModal('flight_form-modal'));

  document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', e => { if (e.target === m) closeModal(); }));
  document.addEventListener('keydown', e => { if (e.key === 'Escape' && activeModal) closeModal(); });

  document.getElementById('purpose-modal').addEventListener('click', e => {
    if (e.target.tagName === 'BUTTON') { const v = e.target.dataset.value; purposeHidden.value = v; purposeDisplay.value = v; closeModal(); }
  });
  document.getElementById('flight_form-modal').addEventListener('click', e => {
    if (e.target.tagName === 'BUTTON') { const v = e.target.dataset.value; formHidden.value = v; formDisplay.value = v; closeModal(); }
  });

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const btn = form.querySelector('button[type="submit"]');
    btn.disabled = true;
    try {
      const payload = Object.fromEntries(new FormData(form).entries());
      const method = logId ? 'PUT' : 'POST';
      const url = logId ? `/api/flight_logs/${encodeURIComponent(logId)}` : '/api/flight_logs';
      await fetchJSON(url, { method, headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      alert('保存しました。');
      window.location.href = '/logs.html';
    } catch (e2) {
      alert(e2.message);
    } finally {
      btn.disabled = false;
    }
  });

  deleteButton.addEventListener('click', async () => {
    if (!logId || !confirm('この日誌を本当に削除しますか？')) return;
    try {
      await fetchJSON(`/api/flight_logs/${encodeURIComponent(logId)}`, { method: 'DELETE' });
      alert('削除しました。');
      window.location.href = '/logs.html';
    } catch (e) {
      alert(e.message);
    }
  });
</script>