<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>飛行日誌</title>
    <script src="/auth.js" defer></script>
    <link rel="stylesheet" href="/style.css">
    <style>
        .modal-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff; border-radius: 8px;
            padding: 2rem; width: 90%; max-width: 400px;
            max-height: 80vh; overflow-y: auto;
        }
        .modal-content h3 { margin-top: 0; }
        .modal-options { display: flex; flex-direction: column; gap: 0.5rem; }
        .modal-options button {
            width: 100%; text-align: left; padding: 0.8em 1em;
            border: 1px solid #ccc; background-color: #f9f9f9;
            border-radius: 4px; cursor: pointer;
        }
        .modal-options button:hover, .modal-options button:focus { background-color: #eee; outline: 2px solid var(--primary-color); }
        .modal-overlay.is-open { display: flex; }
        body.modal-open { overflow: hidden; }

        .pseudo-select {
            background-color: #fff; cursor: pointer;
            border: 1px solid var(--border-color);
            padding: 0.5em 0.75em; border-radius: 4px;
            width: 100%; box-sizing: border-box;
            min-height: calc(1em + 1em + 2px); /* font-size + padding + border */
        }
    </style>
</head>
<body>
<div class="container">
    <a href="/logs.html" class="back-link">&lt; 履歴一覧に戻る</a>
    <h1 id="page-title">飛行日誌作成</h1>
    <form id="flight-form">
      <input type="hidden" name="id">
      
      <h3>日常点検（飛行前）</h3>
      <label>点検年月日: <input type="date" name="precheck_date" required /></label>
      <label>点検者: <input type="text" name="inspector" required /></label>
      <label>実施場所: <input type="text" name="place" required /></label>
      <label>機体全般: <input type="radio" name="body" value="正常" checked required />正常 <input type="radio" name="body" value="異常" required />異常</label>
      <label>プロペラ: <input type="radio" name="propeller" value="正常" checked required />正常 <input type="radio" name="propeller" value="異常" required />異常</label>
      <label>フレーム: <input type="radio" name="frame" value="正常" checked required />正常 <input type="radio" name="frame" value="異常" required />異常</label>
      <label>通信系統: <input type="radio" name="comm" value="正常" checked required />正常 <input type="radio" name="comm" value="異常" required />異常</label>
      <label>推進系統: <input type="radio" name="engine" value="正常" checked required />正常 <input type="radio" name="engine" value="異常" required />異常</label>
      <label>電源系統: <input type="radio" name="power" value="正常" checked required />正常 <input type="radio" name="power" value="異常" required />異常</label>
      <label>自動制御系統: <input type="radio" name="autocontrol" value="正常" checked required />正常 <input type="radio" name="autocontrol" value="異常" required />異常</label>
      <label>操縦装置: <input type="radio" name="controller" value="正常" checked required />正常 <input type="radio" name="controller" value="異常" required />異常</label>
      <label>バッテリー・燃料: <input type="radio" name="battery" value="正常" checked required />正常 <input type="radio" name="battery" value="異常" required />異常</label>

      <h3>飛行記録</h3>
      <label>飛行年月日: <input type="date" name="fly_date" required /></label>
      <label>機体: <select name="drone_id" id="drone-select" required></select></label>
      
      <label>飛行目的:
        <input type="text" id="purpose-display" class="pseudo-select" placeholder="クリックして選択" readonly>
        <input type="hidden" name="purpose" id="purpose-hidden">
      </label>
      <label>飛行形態:
        <input type="text" id="flight_form-display" class="pseudo-select" placeholder="クリックして選択" readonly>
        <input type="hidden" name="flight_form" id="flight_form-hidden">
      </label>

      <label>離陸場所（住所）: <input type="text" name="start_location" required /></label>
      <label>着陸場所（住所）: <input type="text" name="end_location" required /></label>
      
      <h3>飛行時間</h3>
      <label>離陸時刻: <input type="time" name="start_time" id="start-time" /></label>
      <label>着陸時刻: <input type="time" name="end_time" id="end-time" /></label>
      <label>実飛行時間: <input type="text" id="actual-time-display" readonly /></label>
      <input type="hidden" name="actual_time_minutes" id="actual-time-minutes">

      <h3>レポート（飛行中の不具合）</h3>
      <label>飛行中の不具合: <input type="radio" name="flight_abnormal" value="正常" checked required />正常 <input type="radio" name="flight_abnormal" value="異常" required />異常</label>

      <h3>日常点検（飛行後）</h3>
      <label>飛行後点検: <input type="radio" name="aftercheck" value="正常" checked required />正常 <input type="radio" name="aftercheck" value="異常" required />異常</label>

      <button type="submit">この内容で保存</button>
    </form>
    <button type="button" id="delete-button" class="red-btn" style="display: none;">この日誌を削除する</button>
</div>

<div id="purpose-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="purpose-modal-title">
    <div class="modal-content">
        <h3 id="purpose-modal-title">飛行目的を選択</h3>
        <div class="modal-options">
            <button type="button" data-value="訓練">訓練</button>
            <button type="button" data-value="業務">業務</button>
            <button type="button" data-value="その他">その他</button>
        </div>
    </div>
</div>

<div id="flight_form-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="flight_form-modal-title">
    <div class="modal-content">
        <h3 id="flight_form-modal-title">飛行形態を選択</h3>
        <div class="modal-options">
            <button type="button" data-value="目視内飛行">目視内飛行</button>
            <button type="button" data-value="目視外飛行">目視外飛行</button>
            <button type="button" data-value="夜間飛行">夜間飛行</button>
            <button type="button" data-value="25kg以上の機体">25kg以上の機体</button>
            <button type="button" data-value="催し場所上空">催し場所上空</button>
            <button type="button" data-value="危険物輸送">危険物輸送</button>
            <button type="button" data-value="物件投下">物件投下</button>
        </div>
    </div>
</div>

<script>
  const form = document.getElementById('flight-form');
  const pageTitle = document.getElementById('page-title');
  const deleteButton = document.getElementById('delete-button');
  const droneSelect = document.getElementById('drone-select');
  const params = new URLSearchParams(window.location.search);
  const logId = params.get('id');

  const purposeDisplay = document.getElementById('purpose-display');
  const purposeHidden  = document.getElementById('purpose-hidden');
  const formDisplay    = document.getElementById('flight_form-display');
  const formHidden     = document.getElementById('flight_form-hidden');

  const startInput = document.getElementById('start-time');
  const endInput   = document.getElementById('end-time');
  const actualDisplay = document.getElementById('actual-time-display');
  const actualMinutes = document.getElementById('actual-time-minutes');

  function toDateInputString(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function diffMinutes(hhmm1, hhmm2) {
    if (!hhmm1 || !hhmm2) return 0;
    const [h1, m1] = hhmm1.split(':').map(Number);
    const [h2, m2] = hhmm2.split(':').map(Number);
    let a = h1*60 + m1, b = h2*60 + m2, d = b - a;
    if (d < 0) d += 24*60;
    return d;
  }
  function formatMinutes(min) {
    if (!min || min <= 0) return '';
    const h = Math.floor(min/60), m = min%60;
    return h ? `${h}時間${m}分` : `${m}分`;
  }
  function calculateFlightTime() {
    const min = diffMinutes(startInput.value, endInput.value);
    actualDisplay.value = formatMinutes(min);
    actualMinutes.value = min;
  }

  async function fetchJSON(url, opts) {
    const res = await fetch(url, opts);
    if (!res.ok) {
      let msg = 'エラーが発生しました。';
      try { const j = await res.json(); if (j.error) msg = j.error; } catch {}
      throw new Error(msg);
    }
    return res.json();
  }

  async function populateDrones() {
    const json = await fetchJSON('/api/drones');
    droneSelect.innerHTML = '';
    if (!json.data || json.data.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = '（機体が登録されていません）';
      droneSelect.appendChild(opt);
      return;
    }
    json.data.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.textContent = d.nickname || d.model || `#${d.id}`;
      droneSelect.appendChild(opt);
    });
  }

  let activeModal = null, lastFocusedElement = null;
  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    lastFocusedElement = document.activeElement;
    activeModal = modal;
    modal.classList.add('is-open');
    document.body.classList.add('modal-open');
    const buttons = modal.querySelectorAll('button');
    if (buttons.length) buttons[0].focus();
    modal.addEventListener('keydown', trapTab);
  }
  function trapTab(e) {
    if (!activeModal || e.key !== 'Tab') return;
    const buttons = activeModal.querySelectorAll('button');
    if (!buttons.length) return;
    const first = buttons[0], last = buttons[buttons.length - 1];
    if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
    else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
  }
  function closeModal() {
    if (!activeModal) return;
    activeModal.classList.remove('is-open');
    document.body.classList.remove('modal-open');
    activeModal.removeEventListener('keydown', trapTab);
    activeModal = null;
    if (lastFocusedElement) lastFocusedElement.focus();
  }
  
  function populateForm(data) {
    Object.keys(data).forEach(key => {
        const el = form.elements[key];
        if (el && data[key] !== null) {
           if (el.type === 'radio') {
             const radio = form.querySelector(`input[name="${key}"][value="${data[key]}"]`);
             if (radio) radio.checked = true;
           } else if (el.type === 'date') {
             el.value = toDateInputString(data[key]);
           } else {
             el.value = data[key];
           }
        }
    });
    if (data.purpose) { purposeHidden.value = data.purpose; purposeDisplay.value = data.purpose; }
    if (data.flight_form) { formHidden.value = data.flight_form; formDisplay.value = data.flight_form; }
    calculateFlightTime();
  }

  window.addEventListener('load', async () => {
    try {
      await populateDrones();
      if (logId) {
        pageTitle.textContent = '飛行日誌の編集';
        deleteButton.style.display = 'block';
        const j = await fetchJSON(`/api/flight_logs/${encodeURIComponent(logId)}`);
        populateForm(j.data);
      }
    } catch (e) {
      alert(e.message);
    }
  });

  startInput.addEventListener('input', calculateFlightTime);
  endInput.addEventListener('input', calculateFlightTime);
  purposeDisplay.addEventListener('click', () => openModal('purpose-modal'));
  formDisplay.addEventListener('click', () => openModal('flight_form-modal'));

  document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', e => { if (e.target === m) closeModal(); }));
  document.addEventListener('keydown', e => { if (e.key === 'Escape' && activeModal) closeModal(); });

  document.getElementById('purpose-modal').addEventListener('click', e => {
    if (e.target.tagName === 'BUTTON') { const v = e.target.dataset.value; purposeHidden.value = v; purposeDisplay.value = v; closeModal(); }
  });
  document.getElementById('flight_form-modal').addEventListener('click', e => {
    if (e.target.tagName === 'BUTTON') { const v = e.target.dataset.value; formHidden.value = v; formDisplay.value = v; closeModal(); }
  });

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const btn = form.querySelector('button[type="submit"]');
    btn.disabled = true;
    try {
      const payload = Object.fromEntries(new FormData(form).entries());
      const method = logId ? 'PUT' : 'POST';
      const url = logId ? `/api/flight_logs/${encodeURIComponent(logId)}` : '/api/flight_logs';
      await fetchJSON(url, { method, headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      alert('保存しました。');
      window.location.href = '/logs.html';
    } catch (e2) {
      alert(e2.message);
    } finally {
      btn.disabled = false;
    }
  });

  deleteButton.addEventListener('click', async () => {
    if (!logId || !confirm('この日誌を本当に削除しますか？')) return;
    try {
      await fetchJSON(`/api/flight_logs/${encodeURIComponent(logId)}`, { method: 'DELETE' });
      alert('削除しました。');
      window.location.href = '/logs.html';
    } catch (e) {
      alert(e.message);
    }
  });
</script>
</body>
</html>