<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>操縦者情報</title>
    <script src="/auth.js" defer></script>
    <link rel="stylesheet" href="/style.css">
    <style>
        .red-btn { display: inline-block; background: #e95252; color: white; border: none; padding: 0.8em 1.5em; border-radius: 8px; cursor: pointer; text-decoration: none; text-align: center; margin-top: 1em; width: 100%; box-sizing: border-box; }
        .red-btn:disabled { background: #ccc; cursor: not-allowed; }
        .req { color: #e95252; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container" style="padding-top: 50px;">
        <a href="/pilots.html" class="back-link">&lt; 操縦者一覧に戻る</a>
        <h1 id="page-title">操縦者情報</h1>
        <form id="pilot-form">
            <input type="hidden" name="id">
            <h3>基本情報</h3>
            <label>氏名 <span class="req">*</span><input type="text" name="name" required></label>
            <label>氏名（カナ）<input type="text" name="name_kana"></label>
            <label>メールアドレス (ログインID) <span class="req">*</span><input type="email" name="email" required></label>
            <label>電話番号<input type="tel" name="phone"></label>
            <label>郵便番号<input type="text" name="postal_code"></label>
            <label>都道府県<input type="text" name="prefecture"></label>
            <label>住所1（市区町村）<input type="text" name="address1"></label>
            <label>住所2（番地以降）<input type="text" name="address2"></label>
            <label><input type="checkbox" name="has_license" value="true" style="width: auto; margin-right: 8px;">国のライセンスを保有</label>

            <h3>パスワード</h3>
            <label>パスワード <span id="password-note"></span>
                <input type="password" name="password" id="password" autocomplete="new-password">
            </label>
             <label>パスワード（確認用）
                <input type="password" id="password_confirm" autocomplete="new-password">
            </label>

            <h3>飛行時間サマリー</h3>
            <label>これまでの総飛行時間 (例: 10時間30分)<input type="text" id="initial_flight_time_str"></label>
            <input type="hidden" name="initial_flight_minutes" id="initial_flight_minutes">
            <label>このアプリで記録されている飛行時間<input type="text" id="app_flight_hours_display" readonly></label>
            <label>総飛行時間<input type="text" id="total_flight_hours_display" readonly></label>

            <button type="submit" style="margin-top: 1em;">この内容で保存</button>
        </form>
        <button type="button" id="delete-button" class="red-btn" style="display: none;">この操縦者を削除する</button>
    </div>
    <script>
        const form = document.getElementById('pilot-form');
        const pageTitle = document.getElementById('page-title');
        const deleteButton = document.getElementById('delete-button');
        const params = new URLSearchParams(window.location.search);
        const pilotId = params.get('id');
        let currentUserId = null;

        const formatMinutesToHourMinString = (minutes) => {
            if (minutes === null || isNaN(minutes)) return '0時間0分';
            const totalMinutes = Math.round(minutes);
            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            return `${hours}時間${mins}分`;
        };
        const parseTimeToMinutes = (timeStr) => {
            if (!timeStr) return 0;
            let totalMinutes = 0;
            const hourMatch = timeStr.match(/(\d+\.?\d*)\s*時間/);
            const minMatch = timeStr.match(/(\d+)\s*分/);
            if (hourMatch) totalMinutes += parseFloat(hourMatch[1]) * 60;
            if (minMatch) totalMinutes += parseInt(minMatch[1], 10);
            return Math.round(totalMinutes);
        };
        const updateTotalDisplay = () => {
            const initialMinutes = parseTimeToMinutes(document.getElementById('initial_flight_time_str').value);
            const appMinutesEl = document.getElementById('app_flight_hours_display');
            const appMinutes = parseFloat(appMinutesEl.dataset.minutes || '0');
            const totalMinutes = initialMinutes + appMinutes;
            document.getElementById('total_flight_hours_display').value = formatMinutesToHourMinString(totalMinutes);
        };

        window.addEventListener('load', async () => {
            document.getElementById('initial_flight_time_str').addEventListener('input', updateTotalDisplay);
            
            try {
                const userRes = await fetch('/api/current-user');
                const userJson = await userRes.json();
                if (userJson.user) currentUserId = userJson.user.id;
            } catch(e) { /* auth.jsで処理 */ }

            if (pilotId) {
                pageTitle.textContent = '操縦者情報の編集';
                document.getElementById('password').placeholder = '変更する場合のみ入力';
                document.getElementById('password_confirm').placeholder = '変更する場合のみ入力';
                deleteButton.style.display = 'block';

                if (parseInt(pilotId, 10) === currentUserId) {
                    deleteButton.disabled = true;
                    deleteButton.title = '自分自身は削除できません';
                }
                try {
                    const res = await fetch(`/api/pilots/${pilotId}`);
                    if (!res.ok) throw new Error('操縦者情報の読み込みに失敗しました。');
                    const json = await res.json();
                    const pilot = json.data;
                    Object.keys(pilot).forEach(key => {
                        const el = form.elements[key];
                        if (el && key !== 'password') {
                            if (el.type === 'checkbox') el.checked = !!pilot[key];
                            else if (el.name) el.value = pilot[key] || '';
                        }
                    });
                    document.getElementById('initial_flight_time_str').value = formatMinutesToHourMinString(pilot.initial_flight_minutes);
                    const appHoursDisplay = document.getElementById('app_flight_hours_display');
                    appHoursDisplay.value = formatMinutesToHourMinString(pilot.app_flight_minutes);
                    appHoursDisplay.dataset.minutes = pilot.app_flight_minutes || 0;
                    updateTotalDisplay();
                } catch (err) { alert(err.message); }
            } else {
                pageTitle.textContent = '新規操縦者の登録';
                document.getElementById('password').required = true;
                document.getElementById('password_confirm').required = true;
                document.getElementById('password-note').innerHTML = '<span class="req">*</span>';
                deleteButton.style.display = 'none';
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = form.elements.password.value;
            const passwordConfirm = document.getElementById('password_confirm').value;
            if (password !== passwordConfirm) {
                return alert('パスワードと確認用のパスワードが一致しません。');
            }
            document.getElementById('initial_flight_minutes').value = parseTimeToMinutes(document.getElementById('initial_flight_time_str').value);
            const data = Object.fromEntries(new FormData(e.target).entries());
            data.has_license = form.elements.has_license.checked;
            if (!data.password && pilotId) {
                delete data.password;
            }
            
            const method = pilotId ? 'PUT' : 'POST';
            const url = pilotId ? `/api/pilots/${pilotId}` : '/api/pilots';
            try {
                const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.error || '保存に失敗しました。');
                }
                alert('操縦者情報を保存しました。');
                window.location.href = '/pilots.html';
            } catch (err) {
                alert(err.message);
            }
        });

        deleteButton.addEventListener('click', async () => {
            if (confirm('この操縦者を本当に削除しますか？\n関連する日誌や機体があると削除できません。')) {
                try {
                    const res = await fetch(`/api/pilots/${pilotId}`, { method: 'DELETE' });
                    if (!res.ok) {
                        const errData = await res.json();
                        throw new Error(errData.error || '削除に失敗しました。');
                    }
                    alert('操縦者を削除しました。');
                    window.location.href = '/pilots.html';
                } catch (err) {
                    alert(err.message);
                }
            }
        });
    </script>
</body>
</html>