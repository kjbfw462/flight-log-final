<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>操縦者情報</title>
    <script src="/auth.js" defer></script>
    <link rel="stylesheet" href="/style.css">
    <style>
        .red-btn { display: inline-block; background: #e95252; color: white; border: none; padding: 0.8em 1.5em; border-radius: 8px; cursor: pointer; text-decoration: none; text-align: center; margin-top: 1em; width: 100%; box-sizing: border-box; }
        .red-btn:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container" style="padding-top: 50px;">
        <a href="/pilots.html" class="back-link">&lt; 操縦者一覧に戻る</a>
        <h1 id="page-title">操縦者情報の編集</h1>
        <form id="pilot-form">
            <button type="submit" style="margin-top: 1em;">この内容で保存</button>
        </form>
        <button type="button" id="delete-button" class="red-btn" style="display: none;">削除する</button>
    </div>
    <script>
        const form = document.getElementById('pilot-form');
        const deleteButton = document.getElementById('delete-button');
        // ... (他の変数は変更なし) ...
        const params = new URLSearchParams(window.location.search);
        const pilotId = params.get('id');
        let currentUserId = null;

        // ... (時間計算関数は変更なし) ...

        window.addEventListener('load', async () => {
            // ... (loadイベントリスナーの前半は変更なし) ...
            try {
                const userRes = await fetch('/api/current-user');
                const userJson = await userRes.json();
                currentUserId = userJson.user.id;

                if (pilotId) {
                    pageTitle.textContent = '操縦者情報の編集';
                    deleteButton.style.display = 'block';
                    if (parseInt(pilotId, 10) === currentUserId) {
                        deleteButton.disabled = true;
                        deleteButton.title = '自分自身は削除できません';
                    }
                    // ... (try-catchブロックは変更なし) ...
                }
            } catch(e) { /* auth.jsで処理 */ }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            // ... (保存処理は変更なし) ...
        });

        deleteButton.addEventListener('click', async () => {
            if (confirm('この操縦者を本当に削除しますか？\n関連する日誌や機体があると削除できません。')) {
                try {
                    const res = await fetch(`/api/pilots/${pilotId}`, { method: 'DELETE' });
                    if (!res.ok) {
                        const errData = await res.json();
                        throw new Error(errData.error || '削除に失敗しました。');
                    }
                    alert('操縦者を削除しました。');
                    window.location.href = '/pilots.html';
                } catch (err) {
                    alert(err.message);
                }
            }
        });
    </script>
</body>
</html>