<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>点検整備記録</title>
    <script src="/auth.js" defer></script>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <a href="#" id="back-link" class="back-link">&lt; 機体詳細に戻る</a>
        <h1 id="page-title">点検整備記録の作成</h1>
        <form id="maintenance-form">
            <input type="hidden" name="id" id="record-id">
            <input type="hidden" name="drone_id" id="drone-id">

            <label>点検の種類</label>
            <div class="radio-group">
                <label><input type="radio" name="is_maker_maintenance" value="false" checked> 自己点検</label>
                <label><input type="radio" name="is_maker_maintenance" value="true"> メーカー点検</label>
            </div>

            <label>点検整備日 <span class="req">*</span></label>
            <input type="date" name="maintenance_date" required>

            <label>実施者</label>
            <input type="text" name="implementer" placeholder="例: 鈴木 一郎">

            <label>実施場所</label>
            <input type="text" name="location" placeholder="例: 東京都港区">

            <label>点検・修理・改造及び整備の内容</label>
            <textarea name="description" rows="4"></textarea>

            <label>実施理由</label>
            <textarea name="reason" rows="3"></textarea>
            
            <div id="attachment-section" style="display:none;">
                <label>メーカーの点検整備記録アップロード</label>
                <input type="file" name="attachment">
                <p id="current-attachment"></p>
            </div>

            <button type="submit">この内容で保存</button>
        </form>
        <button type="button" id="delete-button" class="red-btn" style="display: none;">この記録を削除する</button>
    </div>
<script>
    const form = document.getElementById('maintenance-form');
    const pageTitle = document.getElementById('page-title');
    const deleteButton = document.getElementById('delete-button');
    const backLink = document.getElementById('back-link');
    const attachmentSection = document.getElementById('attachment-section');

    const params = new URLSearchParams(window.location.search);
    const recordId = params.get('id');
    const droneId = params.get('drone_id');

    window.addEventListener('load', async () => {
        if (recordId) { // --- 編集モード ---
            pageTitle.textContent = '点検整備記録の編集';
            deleteButton.style.display = 'block';
            try {
                const res = await fetch(`/api/maintenance_records/${recordId}`);
                if (!res.ok) throw new Error('記録の読み込みに失敗');
                const json = await res.json();
                const data = json.data;
                
                backLink.href = `/drone-detail.html?id=${data.drone_id}`;
                Object.keys(data).forEach(key => {
                    if (form.elements[key]) {
                        if (form.elements[key].type === 'radio') {
                            form.querySelector(`input[name="${key}"][value="${data[key]}"]`).checked = true;
                        } else if(form.elements[key].type === 'date') {
                            form.elements[key].value = new Date(data[key]).toISOString().split('T')[0];
                        } else {
                            form.elements[key].value = data[key];
                        }
                    }
                });
                
                // 添付ファイル情報表示
                if(data.is_maker_maintenance && data.attachment_path) {
                    attachmentSection.style.display = 'block';
                    document.getElementById('current-attachment').innerHTML = 
                        `現在のファイル: <a href="${data.attachment_path}" target="_blank">表示</a>`;
                }

            } catch (err) { alert(err.message); }

        } else if (droneId) { // --- 新規作成モード ---
            document.getElementById('drone-id').value = droneId;
            backLink.href = `/drone-detail.html?id=${droneId}`;
        }

        // 点検の種類によってファイルアップロード欄の表示を切り替え
        document.querySelectorAll('input[name="is_maker_maintenance"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                attachmentSection.style.display = e.target.value === 'true' ? 'block' : 'none';
            });
        });
        // 初期表示
        if (form.elements.is_maker_maintenance.value === 'true') {
            attachmentSection.style.display = 'block';
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // ★★★ ファイルを含むフォームはFormDataを使う ★★★
        const formData = new FormData(e.target);
        
        const method = recordId ? 'PUT' : 'POST';
        const url = recordId ? `/api/maintenance_records/${recordId}` : '/api/maintenance_records';

        try {
            const res = await fetch(url, {
                method: method,
                body: formData // JSON.stringifyは使わない
            });
            if (!res.ok) {
                const errData = await res.json();
                throw new Error(errData.error || '保存に失敗しました。');
            }
            alert('保存しました');
            window.location.href = backLink.href;
        } catch (err) {
            alert(err.message);
        }
    });

    deleteButton.addEventListener('click', async () => {
        if (!confirm('この記録を本当に削除しますか？')) return;
        try {
            const res = await fetch(`/api/maintenance_records/${recordId}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('削除に失敗しました。');
            alert('削除しました');
            window.location.href = backLink.href;
        } catch (err) { alert(err.message); }
    });
</script>
</body>
</html>